rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // HELPER FUNCTIONS
    // ========================================
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user's role from Firestore
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Helper function to check if user is admin
    // Safely checks if user document exists before reading role
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check if user is accessing their own document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if a service provider is approved
    // Checks if the provider profile exists and has approvalStatus == 'approved'
    // This is used to restrict provider access to service requests/bookings
    function isApprovedProvider(providerId) {
      return exists(/databases/$(database)/documents/providers/$(providerId)) &&
             (get(/databases/$(database)/documents/providers/$(providerId)).data.approvalStatus == 'approved' ||
              (!('approvalStatus' in get(/databases/$(database)/documents/providers/$(providerId)).data) &&
               get(/databases/$(database)/documents/providers/$(providerId)).data.verified == true));
    }
    
    // Helper function to check if authenticated user is the provider for a service request
    // Verifies that the providerId in the service request belongs to an approved provider
    // Supports both UID match (phone auth) and email match (Google auth)
    function isApprovedProviderForServiceRequest(providerId) {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/providers/$(providerId)) &&
             (providerId == request.auth.uid ||
              (request.auth.token.email != null &&
               get(/databases/$(database)/documents/providers/$(providerId)).data.email == request.auth.token.email)) &&
             (get(/databases/$(database)/documents/providers/$(providerId)).data.approvalStatus == 'approved' ||
              (!('approvalStatus' in get(/databases/$(database)/documents/providers/$(providerId)).data) &&
               get(/databases/$(database)/documents/providers/$(providerId)).data.verified == true));
    }
    
    // ========================================
    // USERS COLLECTION
    // ========================================
    match /users/{userId} {
      // Allow users to read their own document
      allow read: if isOwner(userId);
      
      // Allow admins to read all user documents
      allow read: if isAdmin();
      
      // NOTIFICATION SUPPORT: Allow authenticated users to read FCM tokens for sending notifications
      // This allows the app to read FCM tokens from other users' documents to send push notifications
      // Works for both single document reads (.doc().get()) and collection queries
      allow read: if isAuthenticated();
      
      // Allow users to create their own document
      // Role can be set during creation (for new users)
      allow create: if isOwner(userId) &&
                     (
                       // Allow creation without role (will be set later)
                       !('role' in request.resource.data) ||
                       // Allow setting role to customer or provider during creation
                       (request.resource.data.role == 'customer' || request.resource.data.role == 'provider' || 
                        request.resource.data.role == 'patient' || request.resource.data.role == 'doctor')
                     );
      
      // Allow users to update their own document
      // SECURITY: Users CANNOT change their own role if it already exists
      // - Can update any field EXCEPT role (if role already exists)
      // - Can set role during first update if it doesn't exist yet
      // - Can update fcmToken and location for notifications and geolocation
      allow update: if isOwner(userId) && 
                     (
                       // If not changing role field, allow update (e.g., updating fcmToken, profile, etc.)
                       !('role' in request.resource.data) ||
                       // If role doesn't exist in current document, allow setting it to customer/provider
                       (!('role' in resource.data) && 
                        (request.resource.data.role == 'customer' || request.resource.data.role == 'provider' ||
                         request.resource.data.role == 'patient' || request.resource.data.role == 'doctor')) ||
                       // If role exists and is not being changed, allow update
                       (('role' in resource.data) && 
                        resource.data.role == request.resource.data.role)
                     );
      
      // Allow admins to update any user document (including role)
      allow update: if isAdmin();
      
      // Prevent users from deleting their own document
      // Only admins can delete (if needed in future)
      allow delete: if isAdmin();
      
      // Saved Addresses Subcollection (for providers who may need to save addresses)
      match /savedAddresses/{addressId} {
        // Allow users to read their own saved addresses
        allow read: if isAuthenticated() && 
                      request.auth.uid == userId;
        
        // Allow admins to read all saved addresses
        allow read: if isAdmin();
        
        // Allow users to create their own saved addresses
        allow create: if isAuthenticated() && 
                        userId == request.auth.uid;
        
        // Allow users to update their own saved addresses
        allow update: if isAuthenticated() && 
                        userId == request.auth.uid;
        
        // Allow users to delete their own saved addresses
        allow delete: if isAuthenticated() && 
                        userId == request.auth.uid;
        
        // Allow admins to read/update/delete all saved addresses
        allow read, update, delete: if isAdmin();
      }
    }
    
    // ========================================
    // ROLE CHANGE LOGS COLLECTION (Admin only)
    // ========================================
    match /roleChangeLogs/{logId} {
      // Only admins can read role change logs
      allow read: if isAdmin();
      
      // Only admins can create role change logs
      allow create: if isAdmin();
      
      // Prevent updates and deletes
      allow update, delete: if false;
    }
    
    // ========================================
    // SERVICE REQUESTS COLLECTION (formerly consultations)
    // ========================================
    match /consultations/{consultationId} {
      // Allow customers to read their own service requests
      allow read: if isAuthenticated() && 
                    (resource.data.patientId == request.auth.uid || resource.data.customerId == request.auth.uid);
      
      // Allow authenticated providers to read pending service requests (to accept them)
      // This allows providers to see pending consultations that they can accept
      // Note: More permissive to allow reading even if provider document doesn't exist yet
      allow read: if isAuthenticated() && 
                    (resource.data.status == 'pending' || !('status' in resource.data));
      
      // Allow authenticated providers to read service requests where they are the provider
      // This covers consultations in any status (pending, accepted, in-progress, completed)
      // Needed when updating job card status and fetching customerId
      allow read: if isAuthenticated() && 
                    ('doctorId' in resource.data || 'providerId' in resource.data) &&
                    (resource.data.doctorId == request.auth.uid || resource.data.providerId == request.auth.uid);
      
      // Allow authenticated providers to read consultations (for accepting bookings and job card updates)
      // This is needed when updating job card status and fetching customerId
      // More permissive to allow reading consultations in common statuses
      // This covers cases where provider needs to read consultation to get customerId for notifications
      allow read: if isAuthenticated() && 
                    (resource.data.status == 'pending' || 
                     !('status' in resource.data) ||
                     resource.data.status == 'accepted' ||
                     resource.data.status == 'in-progress' ||
                     resource.data.status == 'completed' ||
                     resource.data.status == 'cancelled' ||
                     resource.data.doctorId == request.auth.uid ||
                     resource.data.providerId == request.auth.uid);
      
      // Allow admins to read all service requests
      allow read: if isAdmin();
      
      // Allow authenticated users (customers) to create service requests
      // REQUIREMENT: Phone must be verified
      allow create: if isAuthenticated() && 
                      (request.resource.data.patientId == request.auth.uid || request.resource.data.customerId == request.auth.uid) &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.phoneVerified == true;
      
      // Allow customers to update their own service requests
      allow update: if isAuthenticated() && 
                       (resource.data.patientId == request.auth.uid || resource.data.customerId == request.auth.uid);
      
      // Allow authenticated providers to accept pending service requests by assigning themselves
      // This allows providers to update a pending consultation to 'accepted' and set themselves as providerId/doctorId
      // Also allows updating provider details (name, phone, email, etc.) when accepting
      // Supports both UID-based (phone auth) and email-based (Google auth) provider authentication
      // Note: This rule is permissive to allow providers to accept bookings even if provider document doesn't exist yet
      allow update: if isAuthenticated() && 
                       // Consultation must be pending OR have no provider assigned yet
                       ((resource.data.status == 'pending' || !('status' in resource.data)) ||
                        (!('doctorId' in resource.data) && !('providerId' in resource.data))) &&
                       // Provider must be assigning themselves (UID match)
                       (request.resource.data.doctorId == request.auth.uid || 
                        request.resource.data.providerId == request.auth.uid) &&
                       // Must be updating status to 'accepted'
                       request.resource.data.status == 'accepted' &&
                       // Preserve customer data - cannot change customerId or patientId
                       (request.resource.data.customerId == resource.data.customerId || 
                        (!('customerId' in request.resource.data) && !('customerId' in resource.data))) &&
                       (request.resource.data.patientId == resource.data.patientId || 
                        (!('patientId' in request.resource.data) && !('patientId' in resource.data)));
      
      // Allow approved providers to update service requests where they are already the provider
      allow update: if isAuthenticated() && 
                       ('doctorId' in resource.data || 'providerId' in resource.data) &&
                       isApprovedProviderForServiceRequest(resource.data.doctorId != null ? resource.data.doctorId : resource.data.providerId);
      
      // Allow admins to update any service request
      allow update: if isAdmin();
      
      // Allow admins to delete service requests
      allow delete: if isAdmin();
    }
    
    // ========================================
    // SERVICE PROVIDERS COLLECTION
    // ========================================
    match /providers/{providerId} {
      // PRIMARY RULE: Allow everyone (including unauthenticated users and customers) to read approved provider profiles
      // This is the main rule for collection queries - simple field check without get() calls
      // Customers need this to browse and book services with approved providers
      // This rule must be simple for collection queries to work
      allow read: if resource.data.approvalStatus == 'approved' || 
                     (!('approvalStatus' in resource.data) && resource.data.verified == true);
      
      // PROVIDER RULE: Allow authenticated providers to read their own profile
      // This allows providers to see their own profile even if pending/rejected
      // Supports both UID-based (phone auth) and email-based (Google auth) provider authentication
      allow read: if isAuthenticated() && 
                     (providerId == request.auth.uid ||
                      (request.auth.token.email != null &&
                     'email' in resource.data &&
                       resource.data.email == request.auth.token.email));
      
      // ADMIN RULE: Allow admins to read all provider profiles
      // Note: This uses get() which can be expensive for collection queries
      // For regular users fetching approved providers, the PRIMARY RULE above should handle it
      allow read: if isAdmin();
      
      // NOTIFICATION SUPPORT: Allow authenticated users to read FCM tokens from providers collection
      // This is needed for sending push notifications to providers
      // Limited to prevent abuse
      allow read: if isAuthenticated() && 
                    (request.query.limit == null || request.query.limit <= 10);
      
      // Allow providers to create their own profile (for profile setup)
      // Can create with any document ID as long as email matches auth token
      allow create: if isAuthenticated() && 
                     request.auth.token.email != null &&
                     request.resource.data.email == request.auth.token.email &&
                     (request.resource.data.approvalStatus == 'pending' ||
                      !('approvalStatus' in request.resource.data));
      
      // Allow providers to update their own profile (but cannot change approvalStatus or serviceFee)
      // Providers can request fee changes by setting pendingFeeChange, but cannot directly update serviceFee
      // Can update fcmToken, location fields (currentLocation, lastSeen, isOnline, isAvailable) for notifications and geolocation
      // Supports both UID-based (phone auth) and email-based (Google auth) provider authentication
      // Note: When using .set() with merge:true on non-existent doc, Firestore uses create rule above
      allow update: if isAuthenticated() && 
                     // Provider must be updating their own profile (UID match or email match)
                     (providerId == request.auth.uid ||
                      (request.auth.token.email != null &&
                       'email' in resource.data &&
                     resource.data.email == request.auth.token.email &&
                       request.resource.data.email == request.auth.token.email)) &&
                     (!('approvalStatus' in request.resource.data) ||
                      request.resource.data.approvalStatus == resource.data.approvalStatus) &&
                     // Prevent providers from directly updating consultationFee/serviceFee
                     (!('consultationFee' in request.resource.data) ||
                      request.resource.data.consultationFee == resource.data.consultationFee) &&
                     (!('serviceFee' in request.resource.data) ||
                      request.resource.data.serviceFee == resource.data.serviceFee);
      
      // Admins can create/update/delete any provider profile (including approval status and fee)
      allow create, update, delete: if isAdmin();
    }
    
    // ========================================
    // PROVIDER AVAILABILITY COLLECTION
    // ========================================
    match /availability/{availabilityId} {
      // Allow everyone (customers) to read availability to book services
      allow read: if true;
      
      // Allow providers to create/update their own availability
      // Availability ID format: {providerId}_{date}
      allow create: if isAuthenticated() && 
                     (getUserRole() == 'provider' || getUserRole() == 'doctor' || isAdmin());
      
      // Allow authenticated users (customers) to update availability when booking
      // This is needed for the booking transaction to mark slots as booked
      // Also allow providers to update their own availability
      allow update: if isAuthenticated();
      
      // Allow admins to delete availability
      allow delete: if isAdmin();
    }
    
    // ========================================
    // FEE CHANGE REQUESTS COLLECTION
    // ========================================
    match /feeChangeRequests/{requestId} {
      // Providers can read their own fee change requests
      allow read: if isAuthenticated() && 
                    resource.data.doctorEmail == request.auth.token.email;
      
      // Admins can read all fee change requests
      allow read: if isAdmin();
      
      // Providers can create fee change requests
      allow create: if isAuthenticated() && 
                     request.resource.data.doctorEmail == request.auth.token.email &&
                     request.resource.data.status == 'pending';
      
      // Only admins can update fee change requests (to approve/reject)
      allow update: if isAdmin();
      
      // Only admins can delete fee change requests
      allow delete: if isAdmin();
    }
    
    // ========================================
    // CHAT MESSAGES COLLECTION
    // ========================================
    match /messages/{messageId} {
      // Allow customers to read messages in their service requests
      allow read: if isAuthenticated() && 
                    resource.data.consultationId != null &&
                    exists(/databases/$(database)/documents/consultations/$(resource.data.consultationId)) &&
                    (get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.patientId == request.auth.uid ||
                     get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.customerId == request.auth.uid ||
                     (('doctorId' in get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data || 
                       'providerId' in get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data) &&
                      isApprovedProviderForServiceRequest(get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.doctorId != null ? 
                                                          get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.doctorId : 
                                                          get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.providerId)));
      
      // Allow approved providers to read messages in their service requests
      allow read: if isAuthenticated() && 
                    resource.data.consultationId != null &&
                    exists(/databases/$(database)/documents/consultations/$(resource.data.consultationId)) &&
                    ('doctorId' in get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data || 
                     'providerId' in get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data) &&
                    isApprovedProviderForServiceRequest(get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.doctorId != null ? 
                                                       get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.doctorId : 
                                                       get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.providerId);
      
      // Allow admins to read all messages
      allow read: if isAdmin();
      
      // Allow authenticated users to create messages in their service requests
      allow create: if isAuthenticated() && 
                      request.resource.data.consultationId != null &&
                      exists(/databases/$(database)/documents/consultations/$(request.resource.data.consultationId)) &&
                      (get(/databases/$(database)/documents/consultations/$(request.resource.data.consultationId)).data.patientId == request.auth.uid ||
                       get(/databases/$(database)/documents/consultations/$(request.resource.data.consultationId)).data.customerId == request.auth.uid ||
                       (('doctorId' in get(/databases/$(database)/documents/consultations/$(request.resource.data.consultationId)).data || 
                         'providerId' in get(/databases/$(database)/documents/consultations/$(request.resource.data.consultationId)).data) &&
                        isApprovedProviderForServiceRequest(get(/databases/$(database)/documents/consultations/$(request.resource.data.consultationId)).data.doctorId != null ? 
                                                            get(/databases/$(database)/documents/consultations/$(request.resource.data.consultationId)).data.doctorId : 
                                                            get(/databases/$(database)/documents/consultations/$(request.resource.data.consultationId)).data.providerId)));
      
      // Allow users to update their own messages (e.g., mark as read)
      allow update: if isAuthenticated() && 
                      resource.data.senderId == request.auth.uid;
      
      // Allow admins to update/delete messages
      allow update, delete: if isAdmin();
    }
    
    // ========================================
    // TYPING INDICATORS COLLECTION
    // ========================================
    match /typingIndicators/{indicatorId} {
      // Allow users to read typing indicators for their service requests
      allow read: if isAuthenticated() && 
                    resource.data.consultationId != null &&
                    exists(/databases/$(database)/documents/consultations/$(resource.data.consultationId)) &&
                    (get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.patientId == request.auth.uid ||
                     get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.customerId == request.auth.uid ||
                     (('doctorId' in get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data || 
                       'providerId' in get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data) &&
                      isApprovedProviderForServiceRequest(get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.doctorId != null ? 
                                                          get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.doctorId : 
                                                          get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.providerId)));
      
      // Allow authenticated users to create/update typing indicators for their service requests
      allow create, update: if isAuthenticated() && 
                              request.resource.data.consultationId != null &&
                              exists(/databases/$(database)/documents/consultations/$(request.resource.data.consultationId)) &&
                              (get(/databases/$(database)/documents/consultations/$(request.resource.data.consultationId)).data.patientId == request.auth.uid ||
                               get(/databases/$(database)/documents/consultations/$(request.resource.data.consultationId)).data.customerId == request.auth.uid ||
                               (('doctorId' in get(/databases/$(database)/documents/consultations/$(request.resource.data.consultationId)).data || 
                                 'providerId' in get(/databases/$(database)/documents/consultations/$(request.resource.data.consultationId)).data) &&
                                isApprovedProviderForServiceRequest(get(/databases/$(database)/documents/consultations/$(request.resource.data.consultationId)).data.doctorId != null ? 
                                                                    get(/databases/$(database)/documents/consultations/$(request.resource.data.consultationId)).data.doctorId : 
                                                                    get(/databases/$(database)/documents/consultations/$(request.resource.data.consultationId)).data.providerId)));
      
      // Allow users to delete their own typing indicators
      allow delete: if isAuthenticated() && 
                      resource.data.userId == request.auth.uid;
      
      // Allow admins to delete any typing indicator
      allow delete: if isAdmin();
    }
    
    // ========================================
    // PAYMENTS COLLECTION
    // ========================================
    match /payments/{paymentId} {
      // Allow customers to read their own payment records
      allow read: if isAuthenticated() && 
                    resource.data.consultationId != null &&
                    exists(/databases/$(database)/documents/consultations/$(resource.data.consultationId)) &&
                    (get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.patientId == request.auth.uid ||
                     get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.customerId == request.auth.uid);
      
      // Allow providers to read payment records for their service requests
      allow read: if isAuthenticated() && 
                    resource.data.consultationId != null &&
                    exists(/databases/$(database)/documents/consultations/$(resource.data.consultationId)) &&
                    (('doctorId' in get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data || 
                      'providerId' in get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data) &&
                     isApprovedProviderForServiceRequest(get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.doctorId != null ? 
                                                         get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.doctorId : 
                                                         get(/databases/$(database)/documents/consultations/$(resource.data.consultationId)).data.providerId));
      
      // Allow admins to read all payment records
      allow read: if isAdmin();
      
      // Allow authenticated users (customers) to create payment records for their own service requests
      // This covers both regular payments and COD payments
      allow create: if isAuthenticated() && 
                      request.resource.data.consultationId != null &&
                      exists(/databases/$(database)/documents/consultations/$(request.resource.data.consultationId)) &&
                      (get(/databases/$(database)/documents/consultations/$(request.resource.data.consultationId)).data.patientId == request.auth.uid ||
                       get(/databases/$(database)/documents/consultations/$(request.resource.data.consultationId)).data.customerId == request.auth.uid);
      
      // Allow admins to update/delete payment records
      allow update, delete: if isAdmin();
    }
    
    // ========================================
    // JOB CARDS COLLECTION
    // ========================================
    match /jobCards/{jobCardId} {
      // Allow providers to read their own job cards
      allow read: if isAuthenticated() && 
                    resource.data.providerId == request.auth.uid;
      
      // Allow customers to read job cards for their service requests
      allow read: if isAuthenticated() && 
                    resource.data.customerId == request.auth.uid;
      
      // Allow admins to read all job cards
      allow read: if isAdmin();
      
      // Allow providers to create job cards when accepting bookings
      // REQUIREMENT: Phone must be verified
      allow create: if isAuthenticated() && 
                     request.resource.data.providerId == request.auth.uid &&
                     request.resource.data.status == 'accepted' &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.phoneVerified == true;
      
      // Allow providers to update their own job cards (status changes)
      allow update: if isAuthenticated() && 
                     resource.data.providerId == request.auth.uid &&
                     // Can update status, updatedAt, and other fields but not providerId or customerId
                     request.resource.data.providerId == resource.data.providerId &&
                     request.resource.data.customerId == resource.data.customerId;
      
      // Allow customers to update job cards (e.g., cancel)
      allow update: if isAuthenticated() && 
                     resource.data.customerId == request.auth.uid &&
                     request.resource.data.status == 'cancelled';
      
      // Allow admins to update/delete any job card
      allow update, delete: if isAdmin();
    }
    
    // ========================================
    // REVIEWS COLLECTION
    // ========================================
    match /reviews/{reviewId} {
      // Allow everyone to read reviews (for public display)
      allow read: if true;
      
      // Allow customers to create reviews for their completed jobs
      // REQUIREMENT: Phone must be verified
      allow create: if isAuthenticated() && 
                      request.resource.data.customerId == request.auth.uid &&
                      request.resource.data.rating >= 1 &&
                      request.resource.data.rating <= 5 &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.phoneVerified == true;
      
      // Allow customers to update their own reviews (only if not yet submitted to provider)
      // Once submitted, reviews cannot be edited
      allow update: if isAuthenticated() && 
                     resource.data.customerId == request.auth.uid &&
                     // Prevent changing rating or customerId after creation
                     request.resource.data.rating == resource.data.rating &&
                     request.resource.data.customerId == resource.data.customerId &&
                     request.resource.data.providerId == resource.data.providerId;
      
      // Providers CANNOT edit reviews (read-only for them)
      // Only admins can delete reviews if needed
      allow delete: if isAdmin();
    }
    
    // ========================================
    // SERVICE CATEGORIES COLLECTION
    // ========================================
    match /serviceCategories/{categoryId} {
      // Allow everyone to read service categories
      allow read: if true;
      
      // Only admins can create/update/delete categories
      allow create, update, delete: if isAdmin();
    }
    
    // ========================================
    // DEFAULT: Deny all other collections
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
